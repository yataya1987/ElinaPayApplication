@model BnetApplication.Models.TicketAdd
@{
    ViewBag.Title = "AddTicket";
}

<div class="col-md-12 col-sm-12 col-xs-12" id="mainPage">
    <div class="panel panel-default">
        <div class="panel-heading clearfix">
            <h4 class="" style="text-align:center;">اضافة متابعة </h4>
        </div>
        <div class="panel-body ">

            <form id="TicketForm" name="TicketForm">
                @*<div>
            <div class="funkyradio" style="display:-webkit-box">
                <div class="funkyradio-success" style="width:20%; margin-right:3%">
                    <input type="radio" name="CallType" value="1" id="radio3" onclick='handleQ1Click(this)' ; />
                    <label for="radio3">مشكلة فنية</label>
                </div>
                <div class="funkyradio-warning" style="width:20%; margin-right:3%">
                    <input type="radio" name="CallType" value="2" id="radio4" onclick='handleQ1Click(this)' ; />
                    <label for="radio4">استفسار</label>
                </div>
                <div class="funkyradio-danger" style="width:20%; margin-right:3%">
                    <input type="radio" value="3" name="CallType" id="radio5" onclick='handleQ1Click(this)' ; />
                    <label for="radio5">شكوى</label>
                </div>
                <div class="funkyradio-warning" style="width:20%; margin-right:3%">
                    <input type="radio" value="4" name="CallType" id="radio6" onclick='handleQ1Click(this)' ; />
                    <label for="radio6">New Lead</label>
                </div>
            </div>
        </div>*@

                @*<div class="input-group col-md-6 col-md-offset-3">
            <span class="input-group-addon">نوع المكالمة</span>
            <input type="text" class="form-control" id="caltypevalid" name="caltypevalid" readonly>
        </div>*@

                <br>
                <div class="input-group col-md-6 col-md-offset-3">
                    <span class="input-group-addon">رقم المتصل</span>
                    <input type="text" class="form-control" id="ani" name="Ani">
                </div>
                <br>
                <div class="input-group col-md-6 col-md-offset-3">
                    <span class="input-group-addon">رقم الخدمة</span>

                    <input type="text" id="ServiceNumber" name="ServiceNumber" class="form-control" placeholder="">
                    <span class="input-group-btn">

                        <button class="btn btn-default" id="TeckiSerchBtn" type="button"> 970 |  فحص طلبات سابقة </button>

                    </span>
                </div>

                @*<br>
        <div class="input-group col-md-6 col-md-offset-3">
            <span class="input-group-addon">أسم المشترك</span>
            <input type="text" name="SubscriberName" id="SubscriberName" class="form-control" placeholder="" value="">
        </div>*@

                <br>
                <div class="input-group col-md-6 col-md-offset-3">
                    <span class="input-group-addon">الاسم الاول</span>
                    <input type="text" name="SubscriberFirstName" id="SubscriberFirstName" class="form-control" placeholder="">


                    <span class="input-group-addon">الاسم الثاني</span>
                    <input type="text" name="SubscriberSecName" id="SubscriberSecName" class="form-control" placeholder="">
                </div>
                <br />
                <div class="input-group col-md-6 col-md-offset-3">
                    <span class="input-group-addon">الاسم الثالث</span>
                    <input type="text" name="SubscriberThirdName" id="SubscriberThirdName" class="form-control" placeholder="">


                    <span class="input-group-addon">الاسم الاخير</span>
                    <input type="text" name="SubscriberLastName" id="SubscriberLastName" class="form-control" placeholder="">
                </div>
                <br>
                <div class="input-group col-md-6 col-md-offset-3" id="CallType1" name="CallType1">
                    <span class="input-group-addon">نوع المكالمة</span>
                    <select class="form-control input-lg" id="dropDownProblemType" name="dropDownProblemType" required onchange="handleQ1Click(this)">
                        <option value="">الرجاء اختيار نوع المكالمة ... </option>
                        <option value="1">مشكلة فنية</option>
                        <option value="2">استفسار</option>
                        <option value="3">شكوى</option>
                        <option value="0">New Lead</option>
                    </select>
                </div>
                <br>
                <div class="input-group col-md-6 col-md-offset-3" id="CallerGender" name="CallerGender">
                    <span class="input-group-addon">الجنس</span>
                    <select class="form-control input-lg" id="callerGender" name="callerGender" required>
                        <option value="">الرجاء اختيار جنس المتصل ... </option>
                        <option value="1">ذكر</option>
                        <option value="2">انثى</option>
                    </select>
                </div>
                <br>
                <div class="input-group col-md-6 col-md-offset-3">
                    <span class="input-group-addon">رقم للرجوع /رقم التواصل</span>
                    <input type="text" id="AlternativeNumber" name="AlternativeNumber" regex="/^[0-9]{3}$/i" class="form-control" placeholder="" required>
                </div>
                <br>

                @*<div class="input-group col-md-6 col-md-offset-3" id="main">
            <span class="input-group-addon">العنوان الرئيسي</span>
            @Html.DropDownList("CallAddress", ViewData["CallAddress"] as IEnumerable<SelectListItem>, "اختار العنوان الرئيسي", new { @class = "form-control input-lg" })
        </div>*@

                <br>
                <div class="input-group col-md-6 col-md-offset-3" id="prob" style="display:none">
                    <span class="input-group-addon">عنوان المشكلة</span>
                    @Html.DropDownList("ProblemType", ViewData["ProblemType"] as IEnumerable<SelectListItem>, "الرجاء اختيار عنوان المشكلة ... ", new { @class = "form-control input-lg" })
                    @*<input type="text" id="OthersProblemType" name="OthersProblemType" class="form-control" style="display:none" placeholder="اكتب عنوان المشكلة">*@
                </div>

                <div class="input-group col-md-6 col-md-offset-3" style="display:none;" name="questionsList" id="questionsList">
                    <span class="input-group-addon">نوع الاستفسار</span>
                    @Html.DropDownList("Question", ViewData["Question"] as IEnumerable<SelectListItem>, "الرجاء اختيار نوع الاستفسار ... ", new { @class = "form-control input-lg" })
                </div>
                <br>

                <br>
                <div class="input-group col-md-6 col-md-offset-3">
                    <span class="input-group-addon">التفاصيل</span>
                    <textarea rows="4" type="text" class="form-control" id="TicketDetails" name="TicketDetails"></textarea>
                </div>

                <br>
                @if (!(@ViewBag.UserType == "NightShift"))
                {
                    <div class="input-group col-md-6 col-md-offset-3" style="display:none;" name="routersList" id="routersList">
                        <span class="input-group-addon">نوع الراوتر</span>
                        @Html.DropDownList("Router", ViewData["Router"] as IEnumerable<SelectListItem>, "اختار نوع الراوتر", new { @class = "form-control input-lg" })
                    </div>
                    <br>
                }
                <div class="input-group col-md-6 col-md-offset-3">
                    <button id="save" class="btn btn-success btn-block alert">حفظ</button>
                </div>
            </form>

        </div>
    </div>
</div>

<div class="col-md-12">
    <div id="serchTicket">

    </div>
</div>

<div id="loader" style="display:none"></div>

<div id="myModal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-lg">

        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">تفاصيل المتابعة</h4>
            </div>
            <div class="modal-body">
                <div class="row" id="modelPage">

                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">خروج</button>
            </div>
        </div>

    </div>
</div>

@section scripts{
    @*<script src="https://cdn.jsdelivr.net/jquery.validation/1.15.1/jquery.validate.min.js"></script>*@
    <script src="~/scripts/jquery.validate.min.js"></script>
    <script src="~/scripts/form-validation.js"></script>
    
    <script>


        $(function () {
            // Initialize form validation on the registration form.
            // It has the name attribute "registration"
            $("form[name='TicketForm']").validate({
                // Specify validation rules
                rules: {
                    // The key name on the left side is the name attribute
                    // of an input field. Validation rules are defined
                    // on the right side
                    CallType: "required",
                    caltypevalid: "required",
                    Ani: {
                        required: true,
                        AniValidation: true
                    },
                    SubscriberFirstName: "required",
                    SubscriberSecName: "required",
                    SubscriberThirdName: "required",
                    SubscriberLastName: "required",
                    ProblemType: "required",
                    Question:"required",
                    AlternativeNumber: {
                        AlternativeNumberValidation: true
                    },
                    Router: "required",
                    ServiceNumber: {
                        required: true,
                        ServiceNumberValidation: true
                    },
                    OthersProblemType: {
                        required: true,
                    }
                },
                // Specify validation error messages
                messages: {
                  CallType: "الرجاء اختيار نوع المكالمة",
                    Ani: {
                        required: "الرجاء ادخال رقم المتصل",
                        AniValidation: "الرجاء ادخال رقم المتصل بشكل صحيح"
                    },
                    TicketDetails:"الرجاء ادخال تفاصيل المتابعة",
                    prob: "الرجاء اختيار نوع المشكلة",
                    ProblemType: "الرجاء اختيار نوع المشكلة",
                    Question:"الرجاء اختيار نوع الاستفسار",
                    callerGender : "الرجاء اختيار جنس المتصل",
                    dropDownProblemType : "الرجاء اختيار نوع المشكلة",
                    SubscriberFirstName: "الرجاء ادخال اسم المشترك الاول  ",
                    SubscriberSecName: "الرجاء ادخال اسم المشترك الثاني",
                    SubscriberThirdName: "الرجاء ادخال اسم المشترك الثالث",
                    SubscriberLastName: "الرجاء ادخال اسم المشترك الاخير",
                    AlternativeNumber: "الرجاء ادخال رقم الرجوع بالشكل الصحيح(05xxxxxxxx)او( 970xxxxxxxx)",
                    Router: "الرجاء اختيار نوع الراوتر",
                    caltypevalid: "الرجاء اختيار نوع المكالمة",
                    ServiceNumber: {
                        required: "الرجاء ادخال رقم الخدمة",
                        ServiceNumberValidation: "الرجاء ادخال رقم  الخدمة بشكل صحيح"
                    },
                    OthersProblemType: {
                        required: "الرجاء اختيار عنوان المشكلة"
                    }
                },
                // Make sure the form is submitted to the destination defined
                // in the "action" attribute of the form when valid
                submitHandler: function (form) {
                    $.alert({
                        title: 'حفظ المتابعة',
                        content: 'هل انت متأكد من البيانات المدخلة وتريد حفظ المتابعة؟',
                        rtl: true,
                        closeIcon: true,
                        buttons: {
                            confirm: {
                                text: 'تأكيد',
                                btnClass: 'btn-blue',
                                action: function () {

                                    $.alert({
                                        title: 'تنبه !',
                                        content: function () {
                                            var self = this;
                                            //self.setContent('Checking callback flow');
                                            var form = $("#TicketForm");

                                            return $.ajax({
                                                url: '@Url.Action("AddTicket", "Ticket")',
                                                data: form.serialize(),
                                                type: 'POST',

                                                success: function (data) {
                                                    //Show popup
                                                    if (data.ms == "Success") {
                                                        self.setContentAppend('<div><h3>تمت الاضافة بنجاح</h3></div>');
                                                        document.getElementById("TicketForm").reset();
                                                    }
                                                    else {
                                                        self.setContentAppend('<div><h3>حدث خطأ اثناء الاضافة</h3></div>' + data.ms);

                                                    }


                                                },
                                                error: function (data) {
                                                    //Show popup
                                                    self.setContentAppend('<div>حدث خطأ اثناء الاضافة</div>');

                                                }
                                            });
                                        }
                                    });
                                }
                            },
                            cancel: {
                                text: 'الغاء',
                                action: function () {
                                }
                            }
                        }
                    });
                }
            });



        });

        
        $.validator.methods.ServiceNumberValidation = function (value, element) {
            return this.optional(element) || /^[0-9]{8}$/.test(value);
        };

        $.validator.methods.AlternativeNumberValidation = function (value, element) {
            return this.optional(element) || /^(970)+[0-9]{8}$/.test(value) || /^(05)+[0-9]{8}$/.test(value);
        }

        $.validator.methods.AniValidation = function (value, element) {
            return this.optional(element) || /^[0-9]{6,13}$/.test(value);
        }
        $('#TeckiSerchBtn').click(function () {
            var a = document.forms["TicketForm"]["ServiceNumber"].value;
            if ((a == "") || (a == null)) {
                document.getElementById("ServiceNumber").style.borderColor = "Red";
            }
            else {               
                document.getElementById("ServiceNumber").style.borderColor = "";
                document.getElementById("loader").style.display = "block";
                    $('#serchTicket').load('@Url.Action("GEtTicketPerServiceNo", "Ticket")' + '?no=' + $("#ServiceNumber").val());
                    setTimeout(function () {
                        document.getElementById("loader").style.display = "none";

                    }, 1000);
            }
        })

        var showmodel = function (No) {
            document.getElementById("loader").style.display = "block";
            $('#modelPage').load('@Url.Action("TicketDetails", "Ticket")' + '?no=' + No);
            
            setTimeout(function () {
                document.getElementById("loader").style.display = "none";

            }, 1000);
            $('#myModal').modal('show');
        }

    document.getElementById("ani").value = "@ViewBag.ANI";

    //$("#ProblemType").change(function () {
    //    if ($("#ProblemType").val() == "اخرى")
    //    {
    //         $("#OthersProblemType").show();
    //    }
    //    else
    //    {
    //        $("#OthersProblemType").hide();
    //        $("#OthersProblemType").val($("#OthersProblemType").val());
    //    }
    //});

    function handleQ1Click(myRadio) {
        //alert("Nation");
        if (myRadio.value == 1)
        {
            $("#caltypevalid").val("مشكلة فنية");
            $("#prob").show();            
            $("#routersList").show();
            $("#questionsList").hide();
            document.getElementById("TicketDetails").required = true;
        }
        else if (myRadio.value == 2) {
            $('#caltypevalid').val("استفسار");
            $("#prob").hide();
            $("#routersList").hide();
            $("#questionsList").show();
            document.getElementById("TicketDetails").required = false;
        }
        else if (myRadio.value == 3) {
            $('#caltypevalid').val("شكوى");
            $("#prob").hide();
            $("#routersList").hide();
            $("#questionsList").hide();
            document.getElementById("TicketDetails").required = true;
        }
        else if (myRadio.value == 0) {
            $('#caltypevalid').val("New Lead");
            $("#prob").hide();
            $("#routersList").hide();
            $("#questionsList").hide();
            document.getElementById("TicketDetails").required = true;
        }

        }
        window.onload = function () {
            urlparams = decodeURIComponent(window.location.search.substring(1));
            urlSplittedparams = urlparams.split("&");

            //ani
            urlSplittedparams[0] = urlSplittedparams[0].split("=");
            document.getElementById("ani").value = urlSplittedparams[0][1];

            //seriveNum
            urlSplittedparams[1] = urlSplittedparams[1].split("=");
            urlSplittedparams[1][1] = urlSplittedparams[1][1].split("970");
            document.getElementById("ServiceNumber").value = urlSplittedparams[1][1][1];

            //subscName
            urlSplittedparams[2] = urlSplittedparams[2].split("=");
            urlSplittedparams[2][1] = urlSplittedparams[2][1].split(" ");
            var counter = 0;
            for (var i = 0; i < urlSplittedparams[2][1].length; i++) {
                counter++;
            }
            if (counter == 4) {
                document.getElementById("SubscriberFirstName").value = urlSplittedparams[2][1][0];
                document.getElementById("SubscriberSecName").value = urlSplittedparams[2][1][1];
                document.getElementById("SubscriberThirdName").value = urlSplittedparams[2][1][2];
                document.getElementById("SubscriberLastName").value = urlSplittedparams[2][1][3];
            }
            else {
                var fullName = "";
                for (var i = 0; i < urlSplittedparams[2][1].length; i++) {
                    fullName += urlSplittedparams[2][1][i] + " ";
                }
                document.getElementById("SubscriberFirstName").value = fullName;

            }
            

            //callType
            urlSplittedparams[3] = urlSplittedparams[3].split("=");
            $("#caltypevalid").val("مشكلة فنية");
            $("#prob").show();
            $("#routersList").show();
            $("#questionsList").hide();
            $('#dropDownProblemType').val('1');

            //AlternativeNumber
            urlSplittedparams[4] = urlSplittedparams[4].split("=");
            document.getElementById("AlternativeNumber").value = urlSplittedparams[4][1];

            //ticketDetails
            urlSplittedparams[5] = urlSplittedparams[5].split("=");
            document.getElementById("TicketDetails").value = urlSplittedparams[5][1];

            //problemType
            urlSplittedparams[6] = urlSplittedparams[6].split("=");


        };
    </script>

}



